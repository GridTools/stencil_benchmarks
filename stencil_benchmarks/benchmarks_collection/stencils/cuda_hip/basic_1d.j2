{% extends "base.j2" %}

{% set elements = strides[0] * (domain[0] - 1) + strides[1] * (domain[1] - 1) + strides[2] * (domain[2] - 1) + 1 %}

{% block gpu_kernel_body %}
    {%- if block_size[2] > 1 %}
        int index = {{ block_size[2] }} * blockIdx.z + threadIdx.z;
    {%- elif block_size[1] > 1 %}
        int index = {{ block_size[1] }} * blockIdx.y + threadIdx.y;
    {%- else %}
        int index = {{ block_size[0] }} * blockIdx.x + threadIdx.x;
    {%- endif %}

    if (index < {{ elements }}) {
        {{ body }}
    }
{% endblock gpu_kernel_body %}

{% block kernel_prepare %}
    dim3 block_size({{ block_size[0] }},
                    {{ block_size[1] }},
                    {{ block_size[2] }});
    dim3 grid_size({{ (elements + block_size[0] - 1) // block_size[0] if block_size[0] > 1 else 1 }},
                   {{ (elements + block_size[1] - 1) // block_size[1] if block_size[1] > 1 else 1 }},
                   {{ (elements + block_size[2] - 1) // block_size[2] if block_size[2] > 1 else 1 }});
{% endblock kernel_prepare %}